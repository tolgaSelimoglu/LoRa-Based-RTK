#!/usr/bin/env python
# -*- coding: utf-8 -*-

import rospy
from geometry_msgs.msg import Twist
import serial

# SÄ±nÄ±rlar
Z_MIN = 0
Z_MAX = 180
X_MIN = -1.0
X_MAX = 1.0

# BaÅŸlangÄ±Ã§ deÄŸerleri
x = 0.0
z = 0.0

# UART baÄŸlantÄ±sÄ±nÄ± baÅŸlat
try:
    ser = serial.Serial(
        port='/dev/ttyUSB1',
        baudrate=115200,
        timeout=10
    )
    print "âœ… UART baÄŸlantÄ±sÄ± kuruldu."
except serial.SerialException as e:
    print "âŒ UART baÄŸlantÄ± hatasÄ±:", e
    exit()


# UART mesaj gÃ¶nderme fonksiyonu
def send_uart_update():
    global x, z
    msg = "{:.2f}/{:.2f}".format(x, z)
    print "ğŸ“¤ UART mesajÄ±:", msg
    try:
        ser.write(msg + '\n')
    except Exception as e:
        print "âš ï¸ UART gÃ¶nderim hatasÄ±:", e


# /cmd_vel mesajlarÄ±nÄ± alÄ±p iÅŸle
def cmd_vel_callback(msg):
    global x, z

    # Gelen deÄŸerleri sÄ±nÄ±rla
    x_raw = msg.linear.x
    z_raw = msg.angular.z

    # Clamp iÅŸlemi ve dÃ¶nÃ¼ÅŸÃ¼m (Ã¶rnek: z [-1,1] â†’ [0,180])
    x = max(min(x_raw, X_MAX), X_MIN)
    z = max(min(z_raw * 90 + 90, Z_MAX), Z_MIN)

    send_uart_update()


def main():
    rospy.init_node('cmd_vel_uart_bridge', anonymous=True)
    rospy.Subscriber('/cmd_vel', Twist, cmd_vel_callback)
    print "ğŸ“¡ /cmd_vel dinleniyor..."
    rospy.spin()


if __name__ == "__main__":
    main()

